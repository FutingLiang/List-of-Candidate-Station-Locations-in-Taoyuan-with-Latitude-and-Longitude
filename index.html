<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>公車站位地圖視覺化工具 - Excel 版本</title>
    <!-- XLSX 庫用於 Excel 檔案處理 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Leaflet 地圖庫 (免費，無需 API Key) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 2px,
                rgba(255,255,255,0.05) 2px,
                rgba(255,255,255,0.05) 4px
            );
            animation: slide 20s linear infinite;
        }
        
        @keyframes slide {
            0% { transform: translateX(-50px) translateY(-50px); }
            100% { transform: translateX(50px) translateY(50px); }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .header-content {
            position: relative;
            z-index: 1;
        }
        
        .header h1 {
            font-size: 3em;
            font-weight: 300;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .feature-banner {
            padding: 20px;
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            text-align: center;
            font-weight: 600;
        }
        
        .upload-section {
            padding: 40px;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            border-bottom: 1px solid #dee2e6;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 40px;
            text-align: center;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #5a67d8;
            background: #f8f9ff;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.15);
        }
        
        .upload-area.dragover {
            border-color: #48bb78;
            background: #f0fff4;
        }
        
        .upload-icon {
            font-size: 4em;
            color: #667eea;
            margin-bottom: 20px;
            display: block;
        }
        
        .upload-text {
            font-size: 1.3em;
            color: #4a5568;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .upload-hint {
            color: #718096;
            font-size: 1em;
            margin-bottom: 25px;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        .file-info {
            margin-top: 20px;
            padding: 20px;
            background: #e6fffa;
            border-radius: 10px;
            border-left: 4px solid #38b2ac;
            display: none;
        }
        
        .file-info h3 {
            color: #234e52;
            margin-bottom: 10px;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .demo-section {
            padding: 40px;
            background: #fff8e1;
            border-left: 4px solid #ffb300;
            margin: 20px;
            border-radius: 10px;
        }
        
        .demo-section h3 {
            color: #e65100;
            margin-bottom: 15px;
        }
        
        .demo-btn {
            background: #ff9800;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
        }
        
        .demo-btn:hover {
            background: #f57c00;
            transform: translateY(-2px);
        }
        
        .map-section {
            display: none;
        }
        
        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
        }
        
        .control-group {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }
        
        .control-group:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        
        .control-label {
            display: block;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 0.95em;
        }
        
        select, input[type="range"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }
        
        select:focus, input[type="range"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .range-value {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-top: 8px;
        }
        
        .map-container {
            height: 700px;
            position: relative;
            background: linear-gradient(145deg, #f0f8ff, #e6f3ff);
            overflow: hidden;
        }
        
        #mapCanvas {
            width: 100%;
            height: 100%;
            cursor: crosshair;
            display: block;
        }
        
        .map-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            min-width: 200px;
        }
        
        .map-controls h4 {
            margin: 0 0 15px 0;
            color: #2d3748;
            font-size: 14px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 8px;
        }
        
        .map-controls label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 13px;
            cursor: pointer;
        }
        
        .map-controls input[type="checkbox"] {
            width: auto;
        }
        
        .map-controls button {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .map-controls button:hover {
            background: #5a67d8;
        }
        
        .zoom-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .zoom-btn {
            width: 50px;
            height: 50px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .zoom-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: scale(1.05);
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px;
            border-radius: 10px;
            pointer-events: none;
            z-index: 2000;
            max-width: 320px;
            font-size: 13px;
            display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .info-panel {
            padding: 30px;
            background: #f8f9fa;
        }
        
        .legend {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .legend h3 {
            margin: 0 0 20px 0;
            color: #2d3748;
            font-size: 1.3em;
        }
        
        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 25px;
        }
        
        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border-left: 5px solid #667eea;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
            display: block;
        }
        
        .stat-label {
            color: #718096;
            font-size: 1em;
            font-weight: 500;
        }
        
        .error-message {
            background: #fed7d7;
            border: 1px solid #feb2b2;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }
        
        .success-message {
            background: #c6f6d5;
            border: 1px solid #9ae6b4;
            color: #2f855a;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .upload-area {
                padding: 40px 20px;
            }
            
            .control-grid {
                grid-template-columns: 1fr;
            }
            
            .map-container {
                height: 500px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>🚌 公車站位地圖視覺化工具</h1>
                <p>支援 CSV 格式，純 JavaScript 實作，完全免費使用</p>
            </div>
        </div>
        
        <div class="feature-banner">
            ✨ 零依賴 • 完全本地運行 • 支援 CSV 格式 • 即時互動 ✨
        </div>
        
        <div class="demo-section">
            <h3>🎯 快速開始</h3>
            <p>沒有資料檔案？試試我們的示範資料！</p>
            <button class="demo-btn" onclick="loadDemoData()">載入示範資料</button>
            <button class="demo-btn" onclick="downloadTemplate()">下載 CSV 範本</button>
        </div>
        
        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <span class="upload-icon">📊</span>
                <div class="upload-text">拖放 Excel 檔案到這裡</div>
                <div class="upload-hint">或點擊選擇檔案 (支援 .xlsx, .xls 格式)</div>
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    選擇檔案
                </button>
                <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
            </div>
            
            <div class="file-info" id="fileInfo">
                <h3>檔案資訊</h3>
                <div id="fileName"></div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div id="fileStatus"></div>
            </div>
            
            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>
        </div>
        
        <div class="map-section" id="mapSection">
            <div class="controls">
                <div class="control-grid">
                    <div class="control-group">
                        <label class="control-label" for="districtFilter">行政區篩選</label>
                        <select id="districtFilter">
                            <option value="">全部行政區</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label" for="passengerFilter">最低載客量篩選</label>
                        <input type="range" id="passengerFilter" min="0" max="6000" value="0" step="100">
                        <span class="range-value" id="passengerValue">0</span>
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label" for="routeFilter">最低路線數篩選</label>
                        <input type="range" id="routeFilter" min="1" max="100" value="1" step="1">
                        <span class="range-value" id="routeValue">1</span>
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label">顯示選項</label>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <label style="font-size: 12px;">
                                <input type="checkbox" id="showLabels" checked> 顯示站名
                            </label>
                            <label style="font-size: 12px;">
                                <input type="checkbox" id="showHeatmap"> 熱力圖
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 統計資料區塊 -->
            <div class="stats-section" style="margin-bottom: 20px;">
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-number" id="totalStations">0</span>
                        <div class="stat-label">總站點數</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="avgPassengers">0</span>
                        <div class="stat-label">平均日載客量</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="maxPassengers">0</span>
                        <div class="stat-label">最高日載客量</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="totalRoutes">0</span>
                        <div class="stat-label">總路線數</div>
                    </div>
                </div>
            </div>
            
            <div class="map-container">
                <div class="map-controls">
                    <h4>🎛️ 工具選項</h4>
                    <button onclick="fitMapToMarkers()">🎯 調整視圖</button>
                    <button onclick="exportData()">💾 匯出資料</button>
                    <button onclick="toggleGrid()">📐 顯示網格</button>
                </div>
                
                <div class="zoom-controls">
                    <button class="zoom-btn" onclick="zoomIn()" title="放大">+</button>
                    <button class="zoom-btn" onclick="zoomOut()" title="縮小">−</button>
                    <button class="zoom-btn" onclick="resetView()" title="重置視圖" style="font-size: 16px;">⌂</button>
                </div>
                
                <!-- 地圖載入指示器 -->
                <div id="mapLoading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10; text-align: center; background: rgba(255,255,255,0.9); padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px;"></div>
                    <div style="font-family: Microsoft JhengHei; color: #2d3748; font-size: 14px;">地圖載入中...</div>
                </div>
                
                <!-- Google Maps 容器 -->
                <div id="googleMap" style="width: 100%; height: 100%; position: absolute; top: 0; left: 0;"></div>
                <!-- Canvas 作為備用 -->
                <canvas id="mapCanvas" style="position: absolute; top: 0; left: 0; pointer-events: none; z-index: 1;"></canvas>
                <div class="tooltip" id="tooltip"></div>
            </div>
            
            <div class="info-panel">
                <div class="legend">
                    <h3>圖例說明</h3>
                    <div class="legend-grid">
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #ff4444;"></div>
                            <span>高載客量站點 (>3000人次/日)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #ffaa00;"></div>
                            <span>中載客量站點 (1000-3000人次/日)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #00aa44;"></div>
                            <span>低載客量站點 (<1000人次/日)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局變數
        let canvas, ctx;
        let busStopsData = [];
        let mapBounds = {};
        let scale = 1;
        let offsetX = 0;
        let offsetY = 0;
        let hoveredStop = null;
        let showGrid = false;
        let isDragging = false;
        let lastMousePos = { x: 0, y: 0 };

        // 示範資料
        const demoData = [
            {rank: 1, name: "中壢客運中壢總站", district: "中壢區", boardingAvg: 3100, alightingAvg: 2345, totalPassengers: 5445, longitude: 121.22404, latitude: 24.95317, routeCount: 12},
            {rank: 2, name: "桃園長庚轉運站", district: "龜山區", boardingAvg: 1704, alightingAvg: 1782, totalPassengers: 3486, longitude: 121.36714, latitude: 25.06332, routeCount: 20},
            {rank: 3, name: "內壢火車站", district: "中壢區", boardingAvg: 1423, alightingAvg: 1322, totalPassengers: 2745, longitude: 121.25868, latitude: 24.97318, routeCount: 36},
            {rank: 4, name: "中壢總站", district: "中壢區", boardingAvg: 1520, alightingAvg: 1106, totalPassengers: 2626, longitude: 121.22401, latitude: 24.95319, routeCount: 60},
            {rank: 5, name: "統領百貨", district: "桃園區", boardingAvg: 1452, alightingAvg: 898, totalPassengers: 2350, longitude: 121.31224, latitude: 24.99134, routeCount: 32},
            {rank: 6, name: "長榮", district: "蘆竹區", boardingAvg: 914, alightingAvg: 1437, totalPassengers: 2351, longitude: 121.29514, latitude: 25.04221, routeCount: 18},
            {rank: 7, name: "桃園火車站", district: "桃園區", boardingAvg: 1089, alightingAvg: 1012, totalPassengers: 2101, longitude: 121.31358, latitude: 24.98912, routeCount: 45},
            {rank: 8, name: "中原大學", district: "中壢區", boardingAvg: 756, alightingAvg: 890, totalPassengers: 1646, longitude: 121.23456, latitude: 24.95789, routeCount: 15},
            {rank: 9, name: "桃園高鐵站", district: "中壢區", boardingAvg: 623, alightingAvg: 798, totalPassengers: 1421, longitude: 121.21567, latitude: 24.98456, routeCount: 22},
            {rank: 10, name: "大園工業區", district: "大園區", boardingAvg: 512, alightingAvg: 634, totalPassengers: 1146, longitude: 121.20123, latitude: 25.06789, routeCount: 8},
            {rank: 11, name: "平鎮工業區", district: "平鎮區", boardingAvg: 445, alightingAvg: 567, totalPassengers: 1012, longitude: 121.21789, latitude: 24.94567, routeCount: 12},
            {rank: 12, name: "觀音工業區", district: "觀音區", boardingAvg: 389, alightingAvg: 487, totalPassengers: 876, longitude: 121.15234, latitude: 25.03456, routeCount: 6},
            {rank: 13, name: "八德興豐路", district: "八德區", boardingAvg: 334, alightingAvg: 423, totalPassengers: 757, longitude: 121.29876, latitude: 24.93789, routeCount: 9},
            {rank: 14, name: "龍潭交流道", district: "龍潭區", boardingAvg: 298, alightingAvg: 367, totalPassengers: 665, longitude: 121.21456, latitude: 24.86789, routeCount: 5},
            {rank: 15, name: "大溪老街", district: "大溪區", boardingAvg: 212, alightingAvg: 278, totalPassengers: 490, longitude: 121.28901, latitude: 24.88456, routeCount: 7}
        ];

        // 初始化應用程式
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            initializeUpload();
            setupEventListeners();
            showSuccess('應用程式已準備就緒！可以上傳 Excel 檔案或使用示範資料。');
        });

        // 載入示範資料
        function loadDemoData() {
            busStopsData = [...demoData];
            processLoadedData();
            showSuccess('示範資料載入成功！共載入 ' + busStopsData.length + ' 個站點。');
        }

        // 下載 Excel 範本
        function downloadExcelTemplate() {
            const templateData = [
                ['排名', '站位名稱', '行政區', '平假日加權日均上車量', '平假日加權日均下車量', '平假日加權日均上下車總量', '經度', '緯度', '路線數'],
                [1, '中壢客運中壢總站', '中壢區', 3100.747, 2345.659, 5446.407, 121.22404, 24.95317, 12],
                [2, '桃園長庚轉運站', '龜山區', 1704.561, 1782.948, 3487.509, 121.36714, 25.06332, 20],
                [3, '內壢火車站', '中壢區', 1423.828, 1322.986, 2746.813, 121.25868, 24.97318, 36]
            ];
            
            // 創建 Excel 工作簿
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '公車站位資料');
            // 下載 Excel 檔案
            XLSX.writeFile(wb, '公車站位資料範本.xlsx');
        }

        // 全域變數
        let map = null;
        let markers = [];
        let markerGroup = null;

        // 初始化地圖
        function initMap() {
            // 初始化 Canvas
            canvas = document.getElementById('mapCanvas');
            ctx = canvas.getContext('2d');
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // 設置滑鼠事件
            canvas.addEventListener('mousemove', onMouseMove);
            canvas.addEventListener('mouseout', onMouseOut);
            canvas.addEventListener('wheel', onWheel);
            canvas.addEventListener('mousedown', onMouseDown);
            canvas.addEventListener('mouseup', onMouseUp);
            canvas.addEventListener('mouseleave', onMouseUp);
            
            // 初始化 Leaflet 地圖
            initLeafletMap();
            
            console.log('地圖初始化完成');
        }

        // 初始化 Leaflet 地圖
        function initLeafletMap() {
            const mapContainer = document.getElementById('googleMap');
            const loadingIndicator = document.getElementById('mapLoading');
            
            // 檢查 Leaflet 是否載入
            if (typeof L === 'undefined') {
                console.warn('Leaflet 未載入，使用 Canvas 模式');
                mapContainer.style.display = 'none';
                loadingIndicator.innerHTML = '<div style="color: #e53e3e;">⚠️ 地圖庫載入失敗，使用備用模式</div>';
                setTimeout(() => {
                    loadingIndicator.style.display = 'none';
                }, 3000);
                return;
            }

            // 顯示載入狀態
            loadingIndicator.style.display = 'block';

            try {
                // 桃園市中心座標
                const taoyuanCenter = [24.9937, 121.3010];

                // 創建地圖
                map = L.map('googleMap').setView(taoyuanCenter, 11);

                // 使用更快的地圖服務器（多個備選）
                const tileProviders = [
                    {
                        name: 'CartoDB Positron (快速)',
                        url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
                        attribution: '© OpenStreetMap © CartoDB',
                        maxZoom: 19
                    },
                    {
                        name: 'OpenStreetMap',
                        url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                        attribution: '© OpenStreetMap contributors',
                        maxZoom: 19
                    }
                ];

                // 使用更快的 CartoDB 作為主要圖層
                const tileLayer = L.tileLayer(tileProviders[0].url, {
                    attribution: tileProviders[0].attribution,
                    maxZoom: tileProviders[0].maxZoom,
                    // 性能優化選項
                    updateWhenIdle: true,
                    updateWhenZooming: false,
                    keepBuffer: 2
                });

                // 設置載入超時處理
                let loadTimeout = setTimeout(() => {
                    if (loadingIndicator.style.display !== 'none') {
                        loadingIndicator.innerHTML = `
                            <div style="color: #f56500; margin-bottom: 10px;">⚠️ 網路載入較慢</div>
                            <button onclick="switchToOfflineMode()" style="background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-family: Microsoft JhengHei;">
                                切換到快速模式
                            </button>
                        `;
                    }
                }, 3000); // 3秒後顯示快速模式選項

                // 監聽圖層載入事件
                tileLayer.on('loading', function() {
                    loadingIndicator.innerHTML = `
                        <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px;"></div>
                        <div style="font-family: Microsoft JhengHei; color: #2d3748; font-size: 14px;">載入地圖圖層...</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">首次載入可能需要幾秒鐘</div>
                    `;
                });

                tileLayer.on('load', function() {
                    // 地圖載入完成
                    clearTimeout(loadTimeout);
                    setTimeout(() => {
                        loadingIndicator.style.display = 'none';
                    }, 500);
                });

                tileLayer.addTo(map);

                // 創建標記群組
                markerGroup = L.layerGroup().addTo(map);

                // 隱藏 Canvas，顯示 Leaflet 地圖
                canvas.style.display = 'none';
                
                // 地圖初始化完成
                map.whenReady(function() {
                    console.log('Leaflet 地圖初始化完成');
                    loadingIndicator.innerHTML = `
                        <div style="color: #38a169;">✅ 地圖載入完成</div>
                    `;
                    setTimeout(() => {
                        loadingIndicator.style.display = 'none';
                    }, 1000);
                });

            } catch (error) {
                console.error('地圖初始化錯誤:', error);
                loadingIndicator.innerHTML = `
                    <div style="color: #e53e3e;">❌ 地圖載入失敗</div>
                    <div style="font-size: 12px; margin-top: 5px;">請檢查網路連線</div>
                `;
                setTimeout(() => {
                    loadingIndicator.style.display = 'none';
                }, 3000);
            }
        }

        // 切換到快速模式（純 Canvas）
        function switchToOfflineMode() {
            const loadingIndicator = document.getElementById('mapLoading');
            const mapContainer = document.getElementById('googleMap');
            
            // 隱藏 Leaflet 地圖
            if (map) {
                map.remove();
                map = null;
            }
            mapContainer.style.display = 'none';
            
            // 顯示 Canvas 地圖
            canvas.style.display = 'block';
            
            // 更新載入指示器
            loadingIndicator.innerHTML = `
                <div style="color: #38a169;">⚡ 已切換到快速模式</div>
                <div style="font-size: 12px; margin-top: 5px;">使用離線地圖，載入更快</div>
            `;
            
            setTimeout(() => {
                loadingIndicator.style.display = 'none';
                // 如果有資料，立即繪製
                if (busStopsData.length > 0) {
                    drawMap();
                }
            }, 1000);
            
            console.log('已切換到快速 Canvas 模式');
        }

        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            if (busStopsData.length > 0) {
                drawMap();
            }
        }

        // 初始化檔案上傳
        function initializeUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });

            // 點擊上傳區域事件
            uploadArea.addEventListener('click', function(e) {
                if (e.target.tagName !== 'BUTTON') {
                    fileInput.click();
                }
            });

            // 檔案選擇事件
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
        }

        // 處理檔案
        function handleFile(file) {
            const errorMsg = document.getElementById('errorMessage');
            const successMsg = document.getElementById('successMessage');
            const fileInfo = document.getElementById('fileInfo');
            
            // 重置訊息
            errorMsg.style.display = 'none';
            successMsg.style.display = 'none';
            
            // 檢查檔案類型
            const fileName = file.name.toLowerCase();
            if (!fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
                showError('請選擇 Excel 檔案 (.xlsx 或 .xls)');
                return;
            }

            // 顯示檔案資訊
            fileInfo.style.display = 'block';
            document.getElementById('fileName').innerHTML = `
                <strong>檔案名稱：</strong>${file.name}<br>
                <strong>檔案大小：</strong>${(file.size / 1024).toFixed(2)} KB
            `;
            
            // 模擬進度條
            simulateProgress();
            
            // 檢查 XLSX 庫是否載入
            if (typeof XLSX === 'undefined') {
                showError('Excel 解析庫未載入，請重新整理頁面');
                return;
            }

            // 讀取 Excel 檔案
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // 取得第一個工作表
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // 轉換為 JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    if (jsonData.length === 0) {
                        throw new Error('Excel 檔案中沒有資料');
                    }
                    
                    processData(jsonData);
                    
                } catch (error) {
                    showError('檔案讀取失敗：' + error.message);
                }
            };
            
            reader.onerror = function() {
                showError('檔案讀取過程中發生錯誤');
            };
            
            reader.readAsArrayBuffer(file);
        }



        // 處理載入的資料
        function processData(jsonData) {
            try {
                const firstRow = jsonData[0];
                const keys = Object.keys(firstRow);
                
                console.log('可用欄位:', keys);
                
                // 智能匹配欄位
                const fieldMapping = detectFields(keys);
                
                busStopsData = jsonData.map((row, index) => {
                    const stop = {
                        rank: parseInt(row[fieldMapping.rank]) || index + 1,
                        name: row[fieldMapping.name] || `站點${index + 1}`,
                        district: row[fieldMapping.district] || '未知',
                        boardingAvg: parseFloat(row[fieldMapping.boarding]) || 0,
                        alightingAvg: parseFloat(row[fieldMapping.alighting]) || 0,
                        totalPassengers: parseFloat(row[fieldMapping.total]) || 0,
                        longitude: parseFloat(row[fieldMapping.longitude]) || 0,
                        latitude: parseFloat(row[fieldMapping.latitude]) || 0,
                        routeCount: parseInt(row[fieldMapping.routes]) || 0
                    };
                    
                    // 如果沒有總載客量，嘗試計算
                    if (stop.totalPassengers === 0 && (stop.boardingAvg > 0 || stop.alightingAvg > 0)) {
                        stop.totalPassengers = stop.boardingAvg + stop.alightingAvg;
                    }
                    
                    return stop;
                }).filter(stop => stop.longitude !== 0 && stop.latitude !== 0);

                if (busStopsData.length === 0) {
                    throw new Error('沒有找到有效的經緯度資料。請確認Excel檔案包含經度和緯度欄位。');
                }

                processLoadedData();
                showSuccess(`成功載入 ${busStopsData.length} 個站點資料`);
                
            } catch (error) {
                showError('資料處理失敗：' + error.message);
            }
        }

        // 處理載入完成的資料
        function processLoadedData() {
            calculateMapBounds();
            populateFilters();
            resetView();
            updateStats();
            
            // 顯示地圖區域
            document.getElementById('mapSection').style.display = 'block';
            
            // 滾動到地圖
            setTimeout(() => {
                document.getElementById('mapSection').scrollIntoView({ 
                    behavior: 'smooth' 
                });
            }, 500);
        }

        // 智能偵測欄位
        function detectFields(keys) {
            const mapping = {};
            
            const patterns = {
                rank: ['排名', 'rank', '序號', 'no', 'number'],
                name: ['站位名稱', '站名', 'name', 'station', '站點'],
                district: ['行政區', 'district', '區域', 'area', '地區'],
                boarding: ['上車', 'boarding', '上客', '上車量'],
                alighting: ['下車', 'alighting', '下客', '下車量'],
                total: ['總量', 'total', '合計', '總計', '上下車', '載客量'],
                longitude: ['經度', 'longitude', 'lng', 'lon'],
                latitude: ['緯度', 'latitude', 'lat'],
                routes: ['路線', 'routes', '路線數', 'route']
            };
            
            for (const [field, patterns_list] of Object.entries(patterns)) {
                mapping[field] = keys.find(key => 
                    patterns_list.some(pattern => 
                        key.toLowerCase().includes(pattern.toLowerCase()) ||
                        pattern.toLowerCase().includes(key.toLowerCase())
                    )
                ) || keys[0];
            }
            
            return mapping;
        }

        // 模擬進度條
        function simulateProgress() {
            const progressFill = document.getElementById('progressFill');
            const fileStatus = document.getElementById('fileStatus');
            
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    fileStatus.textContent = '檔案載入完成';
                } else {
                    fileStatus.textContent = `載入中... ${Math.round(progress)}%`;
                }
                progressFill.style.width = progress + '%';
            }, 200);
        }

        // 顯示錯誤訊息
        function showError(message) {
            const errorMsg = document.getElementById('errorMessage');
            errorMsg.textContent = message;
            errorMsg.style.display = 'block';
            document.getElementById('fileInfo').style.display = 'none';
        }

        // 顯示成功訊息
        function showSuccess(message) {
            const successMsg = document.getElementById('successMessage');
            successMsg.textContent = message;
            successMsg.style.display = 'block';
        }

        // 計算地圖邊界
        function calculateMapBounds() {
            const lngs = busStopsData.map(stop => stop.longitude);
            const lats = busStopsData.map(stop => stop.latitude);
            
            mapBounds = {
                minLng: Math.min(...lngs),
                maxLng: Math.max(...lngs),
                minLat: Math.min(...lats),
                maxLat: Math.max(...lats)
            };
            
            // 添加邊距
            const lngPadding = (mapBounds.maxLng - mapBounds.minLng) * 0.1;
            const latPadding = (mapBounds.maxLat - mapBounds.minLat) * 0.1;
            
            mapBounds.minLng -= lngPadding;
            mapBounds.maxLng += lngPadding;
            mapBounds.minLat -= latPadding;
            mapBounds.maxLat += latPadding;
        }

        // 經緯度轉換為螢幕座標
        function coordsToScreen(lng, lat) {
            const x = ((lng - mapBounds.minLng) / (mapBounds.maxLng - mapBounds.minLng)) * canvas.width;
            const y = canvas.height - ((lat - mapBounds.minLat) / (mapBounds.maxLat - mapBounds.minLat)) * canvas.height;
            
            return {
                x: (x + offsetX) * scale,
                y: (y + offsetY) * scale
            };
        }

        // 填充篩選選項
        function populateFilters() {
            const districtSet = new Set();
            busStopsData.forEach(stop => districtSet.add(stop.district));
            
            const districtFilter = document.getElementById('districtFilter');
            districtFilter.innerHTML = '<option value="">全部行政區</option>';
            
            Array.from(districtSet).sort().forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                districtFilter.appendChild(option);
            });
        }

        // 設置事件監聽器
        function setupEventListeners() {
            document.getElementById('districtFilter').addEventListener('change', applyFilters);
            document.getElementById('passengerFilter').addEventListener('input', function(e) {
                document.getElementById('passengerValue').textContent = e.target.value;
                applyFilters();
            });
            document.getElementById('routeFilter').addEventListener('input', function(e) {
                document.getElementById('routeValue').textContent = e.target.value;
                applyFilters();
            });
            document.getElementById('showLabels').addEventListener('change', drawMap);
            document.getElementById('showHeatmap').addEventListener('change', drawMap);
        }

        // 應用篩選器
        function applyFilters() {
            if (busStopsData.length > 0) {
                drawMap();
                updateStats();
            }
        }

        // 更新統計資料
        function updateStats() {
            const filteredData = getFilteredData();
            
            document.getElementById('totalStations').textContent = filteredData.length;
            
            if (filteredData.length > 0) {
                const avgPassengers = Math.round(
                    filteredData.reduce((sum, stop) => sum + stop.totalPassengers, 0) / filteredData.length
                );
                const maxPassengers = Math.max(...filteredData.map(stop => stop.totalPassengers));
                const totalRoutes = new Set(filteredData.map(stop => stop.routeCount)).size;
                
                document.getElementById('avgPassengers').textContent = avgPassengers.toLocaleString();
                document.getElementById('maxPassengers').textContent = maxPassengers.toLocaleString();
                document.getElementById('totalRoutes').textContent = totalRoutes;
            }
        }

        // 獲取篩選後的資料
        function getFilteredData() {
            const districtFilter = document.getElementById('districtFilter').value;
            const passengerFilter = parseInt(document.getElementById('passengerFilter').value);
            const routeFilter = parseInt(document.getElementById('routeFilter').value);
            
            return busStopsData.filter(stop => {
                const districtMatch = !districtFilter || stop.district === districtFilter;
                const passengerMatch = stop.totalPassengers >= passengerFilter;
                const routeMatch = stop.routeCount >= routeFilter;
                
                return districtMatch && passengerMatch && routeMatch;
            });
        }

        // 繪製地圖
        function drawMap() {
            const filteredData = getFilteredData();
            
            // 如果有 Leaflet，使用 Leaflet 模式
            if (map && typeof L !== 'undefined') {
                drawLeafletMarkers(filteredData);
            } else {
                // 否則使用 Canvas 模式
                drawCanvasMap(filteredData);
            }
        }

        // Leaflet 標記繪製
        function drawLeafletMarkers(filteredData) {
            // 清除現有標記
            if (markerGroup) {
                markerGroup.clearLayers();
            }

            // 創建新標記
            filteredData.forEach(stop => {
                // 根據載客量決定顏色和大小
                let color, radius;
                if (stop.totalPassengers > 3000) {
                    color = '#ff4444';
                    radius = 12;
                } else if (stop.totalPassengers > 1000) {
                    color = '#ffaa00';
                    radius = 8;
                } else {
                    color = '#00aa44';
                    radius = 6;
                }

                // 創建圓形標記
                const marker = L.circleMarker([stop.latitude, stop.longitude], {
                    radius: radius,
                    fillColor: color,
                    color: '#ffffff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                });

                // 創建彈出視窗內容
                const popupContent = `
                    <div style="font-family: Microsoft JhengHei; min-width: 200px;">
                        <h3 style="margin: 0 0 10px 0; color: #2d3748;">${stop.name}</h3>
                        <p style="margin: 5px 0;"><strong>行政區：</strong>${stop.district}</p>
                        <p style="margin: 5px 0;"><strong>日載客量：</strong>${stop.totalPassengers.toLocaleString()} 人次</p>
                        <p style="margin: 5px 0;"><strong>路線數：</strong>${stop.routeCount} 條</p>
                        <p style="margin: 5px 0;"><strong>上車：</strong>${stop.boardingAvg.toLocaleString()} 人次</p>
                        <p style="margin: 5px 0;"><strong>下車：</strong>${stop.alightingAvg.toLocaleString()} 人次</p>
                    </div>
                `;

                // 綁定彈出視窗
                marker.bindPopup(popupContent);

                // 添加到標記群組
                markerGroup.addLayer(marker);
            });
        }

        // Canvas 地圖繪製（備用模式）
        function drawCanvasMap(filteredData) {
            if (!canvas || !ctx) return;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 繪製網格
            if (showGrid) {
                drawGrid();
            }
            
            const showLabels = document.getElementById('showLabels').checked;
            const showHeatmap = document.getElementById('showHeatmap').checked;
            
            if (showHeatmap) {
                drawHeatmap(filteredData);
            }
            
            // 繪製站點
            filteredData.forEach(stop => {
                const coords = coordsToScreen(stop.longitude, stop.latitude);
                
                // 根據載客量決定顏色和大小
                let color, size;
                if (stop.totalPassengers > 3000) {
                    color = '#ff4444';
                    size = 8;
                } else if (stop.totalPassengers > 1000) {
                    color = '#ffaa00';
                    size = 6;
                } else {
                    color = '#00aa44';
                    size = 4;
                }
                
                // 繪製圓點
                ctx.beginPath();
                ctx.arc(coords.x, coords.y, size, 0, 2 * Math.PI);
                ctx.fillStyle = color;
                ctx.fill();
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // 繪製站名
                if (showLabels && scale > 1.5) {
                    ctx.fillStyle = '#2d3748';
                    ctx.font = '12px Microsoft JhengHei';
                    ctx.textAlign = 'center';
                    ctx.fillText(stop.name, coords.x, coords.y + size + 15);
                }
            });
        }

        // 繪製網格
        function drawGrid() {
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 1;
            
            const gridSize = 50;
            
            for (let x = 0; x < canvas.width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            for (let y = 0; y < canvas.height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
        }

        // 繪製熱力圖
        function drawHeatmap(data) {
            data.forEach(stop => {
                const coords = coordsToScreen(stop.longitude, stop.latitude);
                const intensity = Math.min(stop.totalPassengers / 5000, 1);
                const radius = 30 * intensity;
                
                const gradient = ctx.createRadialGradient(coords.x, coords.y, 0, coords.x, coords.y, radius);
                gradient.addColorStop(0, `rgba(255, 0, 0, ${intensity * 0.3})`);
                gradient.addColorStop(1, 'rgba(255, 0, 0, 0)');
                
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(coords.x, coords.y, radius, 0, 2 * Math.PI);
                ctx.fill();
            });
        }

        // 滑鼠事件處理
        function onMouseDown(e) {
            isDragging = true;
            const rect = canvas.getBoundingClientRect();
            lastMousePos = {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
            canvas.style.cursor = 'grabbing';
        }

        function onMouseUp() {
            isDragging = false;
            canvas.style.cursor = 'default';
        }

        function onMouseMove(e) {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            if (isDragging) {
                const deltaX = mouseX - lastMousePos.x;
                const deltaY = mouseY - lastMousePos.y;
                
                offsetX += deltaX / scale;
                offsetY += deltaY / scale;
                
                lastMousePos = { x: mouseX, y: mouseY };
                drawMap();
                return;
            }
            
            // 檢查滑鼠懸停
            const filteredData = getFilteredData();
            let foundStop = null;
            
            filteredData.forEach(stop => {
                const coords = coordsToScreen(stop.longitude, stop.latitude);
                const distance = Math.sqrt(
                    Math.pow(mouseX - coords.x, 2) + Math.pow(mouseY - coords.y, 2)
                );
                
                if (distance <= 10) {
                    foundStop = stop;
                }
            });
            
            if (foundStop !== hoveredStop) {
                hoveredStop = foundStop;
                showTooltip(e, foundStop);
                canvas.style.cursor = foundStop ? 'pointer' : 'default';
            }
        }

        function onMouseOut() {
            hoveredStop = null;
            hideTooltip();
            canvas.style.cursor = 'default';
        }

        function onWheel(e) {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            scale *= delta;
            scale = Math.max(0.5, Math.min(scale, 5));
            drawMap();
        }

        // 提示框
        function showTooltip(e, stop) {
            const tooltip = document.getElementById('tooltip');
            if (stop) {
                tooltip.innerHTML = `
                    <strong>${stop.name}</strong><br>
                    行政區：${stop.district}<br>
                    日載客量：${stop.totalPassengers.toLocaleString()}人次<br>
                    路線數：${stop.routeCount}條<br>
                    上車：${stop.boardingAvg.toLocaleString()}人次<br>
                    下車：${stop.alightingAvg.toLocaleString()}人次
                `;
                tooltip.style.display = 'block';
                tooltip.style.left = e.pageX + 10 + 'px';
                tooltip.style.top = e.pageY - 10 + 'px';
            } else {
                hideTooltip();
            }
        }

        function hideTooltip() {
            document.getElementById('tooltip').style.display = 'none';
        }

        // 地圖控制功能
        function zoomIn() {
            if (map && typeof L !== 'undefined') {
                map.setZoom(map.getZoom() + 1);
            } else {
                scale *= 1.2;
                scale = Math.min(scale, 5);
                drawMap();
            }
        }

        function zoomOut() {
            if (map && typeof L !== 'undefined') {
                map.setZoom(map.getZoom() - 1);
            } else {
                scale *= 0.8;
                scale = Math.max(scale, 0.5);
                drawMap();
            }
        }

        function resetView() {
            if (map && typeof L !== 'undefined') {
                map.setView([24.9937, 121.3010], 11);
            } else {
                scale = 1;
                offsetX = 0;
                offsetY = 0;
                drawMap();
            }
        }

        function fitMapToMarkers() {
            if (busStopsData.length === 0) return;
            
            if (map && typeof L !== 'undefined') {
                const filteredData = getFilteredData();
                
                if (filteredData.length > 0) {
                    const group = new L.featureGroup();
                    filteredData.forEach(stop => {
                        group.addLayer(L.marker([stop.latitude, stop.longitude]));
                    });
                    map.fitBounds(group.getBounds().pad(0.1));
                }
            } else {
                calculateMapBounds();
                resetView();
            }
        }

        function toggleGrid() {
            showGrid = !showGrid;
            drawMap();
        }

        function exportData() {
            if (busStopsData.length === 0) {
                showError('沒有資料可以匯出');
                return;
            }
            
            const filteredData = getFilteredData();
            const excelData = [
                ['排名', '站位名稱', '行政區', '上車量', '下車量', '總載客量', '經度', '緯度', '路線數'],
                ...filteredData.map(stop => [
                    stop.rank,
                    stop.name,
                    stop.district,
                    stop.boardingAvg,
                    stop.alightingAvg,
                    stop.totalPassengers,
                    stop.longitude,
                    stop.latitude,
                    stop.routeCount
                ])
            ];
            
            // 創建 Excel 工作簿
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '公車站位資料');
            
            // 下載 Excel 檔案
            XLSX.writeFile(wb, '篩選後的公車站位資料.xlsx');
            
            showSuccess('資料匯出成功！');
        }
    </script>
</body>
</html>
