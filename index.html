<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¬è»Šç«™ä½åœ°åœ–è¦–è¦ºåŒ–å·¥å…· - Excel ç‰ˆæœ¬</title>
    <!-- XLSX åº«ç”¨æ–¼ Excel æª”æ¡ˆè™•ç† -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Leaflet åœ°åœ–åº« (å…è²»ï¼Œç„¡éœ€ API Key) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 2px,
                rgba(255,255,255,0.05) 2px,
                rgba(255,255,255,0.05) 4px
            );
            animation: slide 20s linear infinite;
        }
        
        @keyframes slide {
            0% { transform: translateX(-50px) translateY(-50px); }
            100% { transform: translateX(50px) translateY(50px); }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .header-content {
            position: relative;
            z-index: 1;
        }
        
        .header h1 {
            font-size: 3em;
            font-weight: 300;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .feature-banner {
            padding: 20px;
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            text-align: center;
            font-weight: 600;
        }
        
        .upload-section {
            padding: 40px;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            border-bottom: 1px solid #dee2e6;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 40px;
            text-align: center;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #5a67d8;
            background: #f8f9ff;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.15);
        }
        
        .upload-area.dragover {
            border-color: #48bb78;
            background: #f0fff4;
        }
        
        .upload-icon {
            font-size: 4em;
            color: #667eea;
            margin-bottom: 20px;
            display: block;
        }
        
        .upload-text {
            font-size: 1.3em;
            color: #4a5568;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .upload-hint {
            color: #718096;
            font-size: 1em;
            margin-bottom: 25px;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        .file-info {
            margin-top: 20px;
            padding: 20px;
            background: #e6fffa;
            border-radius: 10px;
            border-left: 4px solid #38b2ac;
            display: none;
        }
        
        .file-info h3 {
            color: #234e52;
            margin-bottom: 10px;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .demo-section {
            padding: 40px;
            background: #fff8e1;
            border-left: 4px solid #ffb300;
            margin: 20px;
            border-radius: 10px;
        }
        
        .demo-section h3 {
            color: #e65100;
            margin-bottom: 15px;
        }
        
        .demo-btn {
            background: #ff9800;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
        }
        
        .demo-btn:hover {
            background: #f57c00;
            transform: translateY(-2px);
        }
        
        .map-section {
            display: none;
        }
        
        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
        }
        
        .control-group {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }
        
        .control-group:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        
        .control-label {
            display: block;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 0.95em;
        }
        
        select, input[type="range"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }
        
        select:focus, input[type="range"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .range-value {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-top: 8px;
        }
        
        .map-container {
            height: 700px;
            position: relative;
            background: linear-gradient(145deg, #f0f8ff, #e6f3ff);
            overflow: hidden;
        }
        
        #mapCanvas {
            width: 100%;
            height: 100%;
            cursor: crosshair;
            display: block;
        }
        
        .map-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            min-width: 200px;
        }
        
        .map-controls h4 {
            margin: 0 0 15px 0;
            color: #2d3748;
            font-size: 14px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 8px;
        }
        
        .map-controls label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 13px;
            cursor: pointer;
        }
        
        .map-controls input[type="checkbox"] {
            width: auto;
        }
        
        .map-controls button {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .map-controls button:hover {
            background: #5a67d8;
        }
        
        .zoom-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .zoom-btn {
            width: 50px;
            height: 50px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .zoom-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: scale(1.05);
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px;
            border-radius: 10px;
            pointer-events: none;
            z-index: 2000;
            max-width: 320px;
            font-size: 13px;
            display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .info-panel {
            padding: 30px;
            background: #f8f9fa;
        }
        
        .legend {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .legend h3 {
            margin: 0 0 20px 0;
            color: #2d3748;
            font-size: 1.3em;
        }
        
        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 25px;
        }
        
        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border-left: 5px solid #667eea;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
            display: block;
        }
        
        .stat-label {
            color: #718096;
            font-size: 1em;
            font-weight: 500;
        }
        
        .error-message {
            background: #fed7d7;
            border: 1px solid #feb2b2;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }
        
        .success-message {
            background: #c6f6d5;
            border: 1px solid #9ae6b4;
            color: #2f855a;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .upload-area {
                padding: 40px 20px;
            }
            
            .control-grid {
                grid-template-columns: 1fr;
            }
            
            .map-container {
                height: 500px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>ğŸšŒ å…¬è»Šç«™ä½åœ°åœ–è¦–è¦ºåŒ–å·¥å…·</h1>
                <p>æ”¯æ´ CSV æ ¼å¼ï¼Œç´” JavaScript å¯¦ä½œï¼Œå®Œå…¨å…è²»ä½¿ç”¨</p>
            </div>
        </div>
        
        <div class="feature-banner">
            âœ¨ é›¶ä¾è³´ â€¢ å®Œå…¨æœ¬åœ°é‹è¡Œ â€¢ æ”¯æ´ CSV æ ¼å¼ â€¢ å³æ™‚äº’å‹• âœ¨
        </div>
        
        <div class="demo-section">
            <h3>ğŸ¯ å¿«é€Ÿé–‹å§‹</h3>
            <p>æ²’æœ‰è³‡æ–™æª”æ¡ˆï¼Ÿè©¦è©¦æˆ‘å€‘çš„ç¤ºç¯„è³‡æ–™ï¼</p>
            <button class="demo-btn" onclick="loadDemoData()">è¼‰å…¥ç¤ºç¯„è³‡æ–™</button>
            <button class="demo-btn" onclick="downloadTemplate()">ä¸‹è¼‰ CSV ç¯„æœ¬</button>
        </div>
        
        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <span class="upload-icon">ğŸ“Š</span>
                <div class="upload-text">æ‹–æ”¾ Excel æª”æ¡ˆåˆ°é€™è£¡</div>
                <div class="upload-hint">æˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ (æ”¯æ´ .xlsx, .xls æ ¼å¼)</div>
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    é¸æ“‡æª”æ¡ˆ
                </button>
                <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
            </div>
            
            <div class="file-info" id="fileInfo">
                <h3>æª”æ¡ˆè³‡è¨Š</h3>
                <div id="fileName"></div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div id="fileStatus"></div>
            </div>
            
            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>
        </div>
        
        <div class="map-section" id="mapSection">
            <div class="controls">
                <div class="control-grid">
                    <div class="control-group">
                        <label class="control-label" for="districtFilter">è¡Œæ”¿å€ç¯©é¸</label>
                        <select id="districtFilter">
                            <option value="">å…¨éƒ¨è¡Œæ”¿å€</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label" for="passengerFilter">æœ€ä½è¼‰å®¢é‡ç¯©é¸</label>
                        <input type="range" id="passengerFilter" min="0" max="6000" value="0" step="100">
                        <span class="range-value" id="passengerValue">0</span>
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label" for="routeFilter">æœ€ä½è·¯ç·šæ•¸ç¯©é¸</label>
                        <input type="range" id="routeFilter" min="1" max="100" value="1" step="1">
                        <span class="range-value" id="routeValue">1</span>
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label">é¡¯ç¤ºé¸é …</label>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <label style="font-size: 12px;">
                                <input type="checkbox" id="showLabels" checked> é¡¯ç¤ºç«™å
                            </label>
                            <label style="font-size: 12px;">
                                <input type="checkbox" id="showHeatmap"> ç†±åŠ›åœ–
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- çµ±è¨ˆè³‡æ–™å€å¡Š -->
            <div class="stats-section" style="margin-bottom: 20px;">
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-number" id="totalStations">0</span>
                        <div class="stat-label">ç¸½ç«™é»æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="avgPassengers">0</span>
                        <div class="stat-label">å¹³å‡æ—¥è¼‰å®¢é‡</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="maxPassengers">0</span>
                        <div class="stat-label">æœ€é«˜æ—¥è¼‰å®¢é‡</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="totalRoutes">0</span>
                        <div class="stat-label">ç¸½è·¯ç·šæ•¸</div>
                    </div>
                </div>
            </div>
            
            <div class="map-container">
                <div class="map-controls">
                    <h4>ğŸ›ï¸ å·¥å…·é¸é …</h4>
                    <button onclick="fitMapToMarkers()">ğŸ¯ èª¿æ•´è¦–åœ–</button>
                    <button onclick="exportData()">ğŸ’¾ åŒ¯å‡ºè³‡æ–™</button>
                    <button onclick="toggleGrid()">ğŸ“ é¡¯ç¤ºç¶²æ ¼</button>
                </div>
                
                <div class="zoom-controls">
                    <button class="zoom-btn" onclick="zoomIn()" title="æ”¾å¤§">+</button>
                    <button class="zoom-btn" onclick="zoomOut()" title="ç¸®å°">âˆ’</button>
                    <button class="zoom-btn" onclick="resetView()" title="é‡ç½®è¦–åœ–" style="font-size: 16px;">âŒ‚</button>
                </div>
                
                <!-- åœ°åœ–è¼‰å…¥æŒ‡ç¤ºå™¨ -->
                <div id="mapLoading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10; text-align: center; background: rgba(255,255,255,0.9); padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px;"></div>
                    <div style="font-family: Microsoft JhengHei; color: #2d3748; font-size: 14px;">åœ°åœ–è¼‰å…¥ä¸­...</div>
                </div>
                
                <!-- Google Maps å®¹å™¨ -->
                <div id="googleMap" style="width: 100%; height: 100%; position: absolute; top: 0; left: 0;"></div>
                <!-- Canvas ä½œç‚ºå‚™ç”¨ -->
                <canvas id="mapCanvas" style="position: absolute; top: 0; left: 0; pointer-events: none; z-index: 1;"></canvas>
                <div class="tooltip" id="tooltip"></div>
            </div>
            
            <div class="info-panel">
                <div class="legend">
                    <h3>åœ–ä¾‹èªªæ˜</h3>
                    <div class="legend-grid">
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #ff4444;"></div>
                            <span>é«˜è¼‰å®¢é‡ç«™é» (>3000äººæ¬¡/æ—¥)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #ffaa00;"></div>
                            <span>ä¸­è¼‰å®¢é‡ç«™é» (1000-3000äººæ¬¡/æ—¥)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #00aa44;"></div>
                            <span>ä½è¼‰å®¢é‡ç«™é» (<1000äººæ¬¡/æ—¥)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€è®Šæ•¸
        let canvas, ctx;
        let busStopsData = [];
        let mapBounds = {};
        let scale = 1;
        let offsetX = 0;
        let offsetY = 0;
        let hoveredStop = null;
        let showGrid = false;
        let isDragging = false;
        let lastMousePos = { x: 0, y: 0 };

        // ç¤ºç¯„è³‡æ–™
        const demoData = [
            {rank: 1, name: "ä¸­å£¢å®¢é‹ä¸­å£¢ç¸½ç«™", district: "ä¸­å£¢å€", boardingAvg: 3100, alightingAvg: 2345, totalPassengers: 5445, longitude: 121.22404, latitude: 24.95317, routeCount: 12},
            {rank: 2, name: "æ¡ƒåœ’é•·åºšè½‰é‹ç«™", district: "é¾œå±±å€", boardingAvg: 1704, alightingAvg: 1782, totalPassengers: 3486, longitude: 121.36714, latitude: 25.06332, routeCount: 20},
            {rank: 3, name: "å…§å£¢ç«è»Šç«™", district: "ä¸­å£¢å€", boardingAvg: 1423, alightingAvg: 1322, totalPassengers: 2745, longitude: 121.25868, latitude: 24.97318, routeCount: 36},
            {rank: 4, name: "ä¸­å£¢ç¸½ç«™", district: "ä¸­å£¢å€", boardingAvg: 1520, alightingAvg: 1106, totalPassengers: 2626, longitude: 121.22401, latitude: 24.95319, routeCount: 60},
            {rank: 5, name: "çµ±é ˜ç™¾è²¨", district: "æ¡ƒåœ’å€", boardingAvg: 1452, alightingAvg: 898, totalPassengers: 2350, longitude: 121.31224, latitude: 24.99134, routeCount: 32},
            {rank: 6, name: "é•·æ¦®", district: "è˜†ç«¹å€", boardingAvg: 914, alightingAvg: 1437, totalPassengers: 2351, longitude: 121.29514, latitude: 25.04221, routeCount: 18},
            {rank: 7, name: "æ¡ƒåœ’ç«è»Šç«™", district: "æ¡ƒåœ’å€", boardingAvg: 1089, alightingAvg: 1012, totalPassengers: 2101, longitude: 121.31358, latitude: 24.98912, routeCount: 45},
            {rank: 8, name: "ä¸­åŸå¤§å­¸", district: "ä¸­å£¢å€", boardingAvg: 756, alightingAvg: 890, totalPassengers: 1646, longitude: 121.23456, latitude: 24.95789, routeCount: 15},
            {rank: 9, name: "æ¡ƒåœ’é«˜éµç«™", district: "ä¸­å£¢å€", boardingAvg: 623, alightingAvg: 798, totalPassengers: 1421, longitude: 121.21567, latitude: 24.98456, routeCount: 22},
            {rank: 10, name: "å¤§åœ’å·¥æ¥­å€", district: "å¤§åœ’å€", boardingAvg: 512, alightingAvg: 634, totalPassengers: 1146, longitude: 121.20123, latitude: 25.06789, routeCount: 8},
            {rank: 11, name: "å¹³é®å·¥æ¥­å€", district: "å¹³é®å€", boardingAvg: 445, alightingAvg: 567, totalPassengers: 1012, longitude: 121.21789, latitude: 24.94567, routeCount: 12},
            {rank: 12, name: "è§€éŸ³å·¥æ¥­å€", district: "è§€éŸ³å€", boardingAvg: 389, alightingAvg: 487, totalPassengers: 876, longitude: 121.15234, latitude: 25.03456, routeCount: 6},
            {rank: 13, name: "å…«å¾·èˆˆè±è·¯", district: "å…«å¾·å€", boardingAvg: 334, alightingAvg: 423, totalPassengers: 757, longitude: 121.29876, latitude: 24.93789, routeCount: 9},
            {rank: 14, name: "é¾æ½­äº¤æµé“", district: "é¾æ½­å€", boardingAvg: 298, alightingAvg: 367, totalPassengers: 665, longitude: 121.21456, latitude: 24.86789, routeCount: 5},
            {rank: 15, name: "å¤§æºªè€è¡—", district: "å¤§æºªå€", boardingAvg: 212, alightingAvg: 278, totalPassengers: 490, longitude: 121.28901, latitude: 24.88456, routeCount: 7}
        ];

        // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            initializeUpload();
            setupEventListeners();
            showSuccess('æ‡‰ç”¨ç¨‹å¼å·²æº–å‚™å°±ç·’ï¼å¯ä»¥ä¸Šå‚³ Excel æª”æ¡ˆæˆ–ä½¿ç”¨ç¤ºç¯„è³‡æ–™ã€‚');
        });

        // è¼‰å…¥ç¤ºç¯„è³‡æ–™
        function loadDemoData() {
            busStopsData = [...demoData];
            processLoadedData();
            showSuccess('ç¤ºç¯„è³‡æ–™è¼‰å…¥æˆåŠŸï¼å…±è¼‰å…¥ ' + busStopsData.length + ' å€‹ç«™é»ã€‚');
        }

        // ä¸‹è¼‰ Excel ç¯„æœ¬
        function downloadExcelTemplate() {
            const templateData = [
                ['æ’å', 'ç«™ä½åç¨±', 'è¡Œæ”¿å€', 'å¹³å‡æ—¥åŠ æ¬Šæ—¥å‡ä¸Šè»Šé‡', 'å¹³å‡æ—¥åŠ æ¬Šæ—¥å‡ä¸‹è»Šé‡', 'å¹³å‡æ—¥åŠ æ¬Šæ—¥å‡ä¸Šä¸‹è»Šç¸½é‡', 'ç¶“åº¦', 'ç·¯åº¦', 'è·¯ç·šæ•¸'],
                [1, 'ä¸­å£¢å®¢é‹ä¸­å£¢ç¸½ç«™', 'ä¸­å£¢å€', 3100.747, 2345.659, 5446.407, 121.22404, 24.95317, 12],
                [2, 'æ¡ƒåœ’é•·åºšè½‰é‹ç«™', 'é¾œå±±å€', 1704.561, 1782.948, 3487.509, 121.36714, 25.06332, 20],
                [3, 'å…§å£¢ç«è»Šç«™', 'ä¸­å£¢å€', 1423.828, 1322.986, 2746.813, 121.25868, 24.97318, 36]
            ];
            
            // å‰µå»º Excel å·¥ä½œç°¿
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'å…¬è»Šç«™ä½è³‡æ–™');
            // ä¸‹è¼‰ Excel æª”æ¡ˆ
            XLSX.writeFile(wb, 'å…¬è»Šç«™ä½è³‡æ–™ç¯„æœ¬.xlsx');
        }

        // å…¨åŸŸè®Šæ•¸
        let map = null;
        let markers = [];
        let markerGroup = null;

        // åˆå§‹åŒ–åœ°åœ–
        function initMap() {
            // åˆå§‹åŒ– Canvas
            canvas = document.getElementById('mapCanvas');
            ctx = canvas.getContext('2d');
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // è¨­ç½®æ»‘é¼ äº‹ä»¶
            canvas.addEventListener('mousemove', onMouseMove);
            canvas.addEventListener('mouseout', onMouseOut);
            canvas.addEventListener('wheel', onWheel);
            canvas.addEventListener('mousedown', onMouseDown);
            canvas.addEventListener('mouseup', onMouseUp);
            canvas.addEventListener('mouseleave', onMouseUp);
            
            // åˆå§‹åŒ– Leaflet åœ°åœ–
            initLeafletMap();
            
            console.log('åœ°åœ–åˆå§‹åŒ–å®Œæˆ');
        }

        // åˆå§‹åŒ– Leaflet åœ°åœ–
        function initLeafletMap() {
            const mapContainer = document.getElementById('googleMap');
            const loadingIndicator = document.getElementById('mapLoading');
            
            // æª¢æŸ¥ Leaflet æ˜¯å¦è¼‰å…¥
            if (typeof L === 'undefined') {
                console.warn('Leaflet æœªè¼‰å…¥ï¼Œä½¿ç”¨ Canvas æ¨¡å¼');
                mapContainer.style.display = 'none';
                loadingIndicator.innerHTML = '<div style="color: #e53e3e;">âš ï¸ åœ°åœ–åº«è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨å‚™ç”¨æ¨¡å¼</div>';
                setTimeout(() => {
                    loadingIndicator.style.display = 'none';
                }, 3000);
                return;
            }

            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            loadingIndicator.style.display = 'block';

            try {
                // æ¡ƒåœ’å¸‚ä¸­å¿ƒåº§æ¨™
                const taoyuanCenter = [24.9937, 121.3010];

                // å‰µå»ºåœ°åœ–
                map = L.map('googleMap').setView(taoyuanCenter, 11);

                // ä½¿ç”¨æ›´å¿«çš„åœ°åœ–æœå‹™å™¨ï¼ˆå¤šå€‹å‚™é¸ï¼‰
                const tileProviders = [
                    {
                        name: 'CartoDB Positron (å¿«é€Ÿ)',
                        url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
                        attribution: 'Â© OpenStreetMap Â© CartoDB',
                        maxZoom: 19
                    },
                    {
                        name: 'OpenStreetMap',
                        url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                        attribution: 'Â© OpenStreetMap contributors',
                        maxZoom: 19
                    }
                ];

                // ä½¿ç”¨æ›´å¿«çš„ CartoDB ä½œç‚ºä¸»è¦åœ–å±¤
                const tileLayer = L.tileLayer(tileProviders[0].url, {
                    attribution: tileProviders[0].attribution,
                    maxZoom: tileProviders[0].maxZoom,
                    // æ€§èƒ½å„ªåŒ–é¸é …
                    updateWhenIdle: true,
                    updateWhenZooming: false,
                    keepBuffer: 2
                });

                // è¨­ç½®è¼‰å…¥è¶…æ™‚è™•ç†
                let loadTimeout = setTimeout(() => {
                    if (loadingIndicator.style.display !== 'none') {
                        loadingIndicator.innerHTML = `
                            <div style="color: #f56500; margin-bottom: 10px;">âš ï¸ ç¶²è·¯è¼‰å…¥è¼ƒæ…¢</div>
                            <button onclick="switchToOfflineMode()" style="background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-family: Microsoft JhengHei;">
                                åˆ‡æ›åˆ°å¿«é€Ÿæ¨¡å¼
                            </button>
                        `;
                    }
                }, 3000); // 3ç§’å¾Œé¡¯ç¤ºå¿«é€Ÿæ¨¡å¼é¸é …

                // ç›£è½åœ–å±¤è¼‰å…¥äº‹ä»¶
                tileLayer.on('loading', function() {
                    loadingIndicator.innerHTML = `
                        <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px;"></div>
                        <div style="font-family: Microsoft JhengHei; color: #2d3748; font-size: 14px;">è¼‰å…¥åœ°åœ–åœ–å±¤...</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">é¦–æ¬¡è¼‰å…¥å¯èƒ½éœ€è¦å¹¾ç§’é˜</div>
                    `;
                });

                tileLayer.on('load', function() {
                    // åœ°åœ–è¼‰å…¥å®Œæˆ
                    clearTimeout(loadTimeout);
                    setTimeout(() => {
                        loadingIndicator.style.display = 'none';
                    }, 500);
                });

                tileLayer.addTo(map);

                // å‰µå»ºæ¨™è¨˜ç¾¤çµ„
                markerGroup = L.layerGroup().addTo(map);

                // éš±è— Canvasï¼Œé¡¯ç¤º Leaflet åœ°åœ–
                canvas.style.display = 'none';
                
                // åœ°åœ–åˆå§‹åŒ–å®Œæˆ
                map.whenReady(function() {
                    console.log('Leaflet åœ°åœ–åˆå§‹åŒ–å®Œæˆ');
                    loadingIndicator.innerHTML = `
                        <div style="color: #38a169;">âœ… åœ°åœ–è¼‰å…¥å®Œæˆ</div>
                    `;
                    setTimeout(() => {
                        loadingIndicator.style.display = 'none';
                    }, 1000);
                });

            } catch (error) {
                console.error('åœ°åœ–åˆå§‹åŒ–éŒ¯èª¤:', error);
                loadingIndicator.innerHTML = `
                    <div style="color: #e53e3e;">âŒ åœ°åœ–è¼‰å…¥å¤±æ•—</div>
                    <div style="font-size: 12px; margin-top: 5px;">è«‹æª¢æŸ¥ç¶²è·¯é€£ç·š</div>
                `;
                setTimeout(() => {
                    loadingIndicator.style.display = 'none';
                }, 3000);
            }
        }

        // åˆ‡æ›åˆ°å¿«é€Ÿæ¨¡å¼ï¼ˆç´” Canvasï¼‰
        function switchToOfflineMode() {
            const loadingIndicator = document.getElementById('mapLoading');
            const mapContainer = document.getElementById('googleMap');
            
            // éš±è— Leaflet åœ°åœ–
            if (map) {
                map.remove();
                map = null;
            }
            mapContainer.style.display = 'none';
            
            // é¡¯ç¤º Canvas åœ°åœ–
            canvas.style.display = 'block';
            
            // æ›´æ–°è¼‰å…¥æŒ‡ç¤ºå™¨
            loadingIndicator.innerHTML = `
                <div style="color: #38a169;">âš¡ å·²åˆ‡æ›åˆ°å¿«é€Ÿæ¨¡å¼</div>
                <div style="font-size: 12px; margin-top: 5px;">ä½¿ç”¨é›¢ç·šåœ°åœ–ï¼Œè¼‰å…¥æ›´å¿«</div>
            `;
            
            setTimeout(() => {
                loadingIndicator.style.display = 'none';
                // å¦‚æœæœ‰è³‡æ–™ï¼Œç«‹å³ç¹ªè£½
                if (busStopsData.length > 0) {
                    drawMap();
                }
            }, 1000);
            
            console.log('å·²åˆ‡æ›åˆ°å¿«é€Ÿ Canvas æ¨¡å¼');
        }

        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            if (busStopsData.length > 0) {
                drawMap();
            }
        }

        // åˆå§‹åŒ–æª”æ¡ˆä¸Šå‚³
        function initializeUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });

            // é»æ“Šä¸Šå‚³å€åŸŸäº‹ä»¶
            uploadArea.addEventListener('click', function(e) {
                if (e.target.tagName !== 'BUTTON') {
                    fileInput.click();
                }
            });

            // æª”æ¡ˆé¸æ“‡äº‹ä»¶
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
        }

        // è™•ç†æª”æ¡ˆ
        function handleFile(file) {
            const errorMsg = document.getElementById('errorMessage');
            const successMsg = document.getElementById('successMessage');
            const fileInfo = document.getElementById('fileInfo');
            
            // é‡ç½®è¨Šæ¯
            errorMsg.style.display = 'none';
            successMsg.style.display = 'none';
            
            // æª¢æŸ¥æª”æ¡ˆé¡å‹
            const fileName = file.name.toLowerCase();
            if (!fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
                showError('è«‹é¸æ“‡ Excel æª”æ¡ˆ (.xlsx æˆ– .xls)');
                return;
            }

            // é¡¯ç¤ºæª”æ¡ˆè³‡è¨Š
            fileInfo.style.display = 'block';
            document.getElementById('fileName').innerHTML = `
                <strong>æª”æ¡ˆåç¨±ï¼š</strong>${file.name}<br>
                <strong>æª”æ¡ˆå¤§å°ï¼š</strong>${(file.size / 1024).toFixed(2)} KB
            `;
            
            // æ¨¡æ“¬é€²åº¦æ¢
            simulateProgress();
            
            // æª¢æŸ¥ XLSX åº«æ˜¯å¦è¼‰å…¥
            if (typeof XLSX === 'undefined') {
                showError('Excel è§£æåº«æœªè¼‰å…¥ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
                return;
            }

            // è®€å– Excel æª”æ¡ˆ
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // å–å¾—ç¬¬ä¸€å€‹å·¥ä½œè¡¨
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // è½‰æ›ç‚º JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    if (jsonData.length === 0) {
                        throw new Error('Excel æª”æ¡ˆä¸­æ²’æœ‰è³‡æ–™');
                    }
                    
                    processData(jsonData);
                    
                } catch (error) {
                    showError('æª”æ¡ˆè®€å–å¤±æ•—ï¼š' + error.message);
                }
            };
            
            reader.onerror = function() {
                showError('æª”æ¡ˆè®€å–éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤');
            };
            
            reader.readAsArrayBuffer(file);
        }



        // è™•ç†è¼‰å…¥çš„è³‡æ–™
        function processData(jsonData) {
            try {
                const firstRow = jsonData[0];
                const keys = Object.keys(firstRow);
                
                console.log('å¯ç”¨æ¬„ä½:', keys);
                
                // æ™ºèƒ½åŒ¹é…æ¬„ä½
                const fieldMapping = detectFields(keys);
                
                busStopsData = jsonData.map((row, index) => {
                    const stop = {
                        rank: parseInt(row[fieldMapping.rank]) || index + 1,
                        name: row[fieldMapping.name] || `ç«™é»${index + 1}`,
                        district: row[fieldMapping.district] || 'æœªçŸ¥',
                        boardingAvg: parseFloat(row[fieldMapping.boarding]) || 0,
                        alightingAvg: parseFloat(row[fieldMapping.alighting]) || 0,
                        totalPassengers: parseFloat(row[fieldMapping.total]) || 0,
                        longitude: parseFloat(row[fieldMapping.longitude]) || 0,
                        latitude: parseFloat(row[fieldMapping.latitude]) || 0,
                        routeCount: parseInt(row[fieldMapping.routes]) || 0
                    };
                    
                    // å¦‚æœæ²’æœ‰ç¸½è¼‰å®¢é‡ï¼Œå˜—è©¦è¨ˆç®—
                    if (stop.totalPassengers === 0 && (stop.boardingAvg > 0 || stop.alightingAvg > 0)) {
                        stop.totalPassengers = stop.boardingAvg + stop.alightingAvg;
                    }
                    
                    return stop;
                }).filter(stop => stop.longitude !== 0 && stop.latitude !== 0);

                if (busStopsData.length === 0) {
                    throw new Error('æ²’æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„ç¶“ç·¯åº¦è³‡æ–™ã€‚è«‹ç¢ºèªExcelæª”æ¡ˆåŒ…å«ç¶“åº¦å’Œç·¯åº¦æ¬„ä½ã€‚');
                }

                processLoadedData();
                showSuccess(`æˆåŠŸè¼‰å…¥ ${busStopsData.length} å€‹ç«™é»è³‡æ–™`);
                
            } catch (error) {
                showError('è³‡æ–™è™•ç†å¤±æ•—ï¼š' + error.message);
            }
        }

        // è™•ç†è¼‰å…¥å®Œæˆçš„è³‡æ–™
        function processLoadedData() {
            calculateMapBounds();
            populateFilters();
            resetView();
            updateStats();
            
            // é¡¯ç¤ºåœ°åœ–å€åŸŸ
            document.getElementById('mapSection').style.display = 'block';
            
            // æ»¾å‹•åˆ°åœ°åœ–
            setTimeout(() => {
                document.getElementById('mapSection').scrollIntoView({ 
                    behavior: 'smooth' 
                });
            }, 500);
        }

        // æ™ºèƒ½åµæ¸¬æ¬„ä½
        function detectFields(keys) {
            const mapping = {};
            
            const patterns = {
                rank: ['æ’å', 'rank', 'åºè™Ÿ', 'no', 'number'],
                name: ['ç«™ä½åç¨±', 'ç«™å', 'name', 'station', 'ç«™é»'],
                district: ['è¡Œæ”¿å€', 'district', 'å€åŸŸ', 'area', 'åœ°å€'],
                boarding: ['ä¸Šè»Š', 'boarding', 'ä¸Šå®¢', 'ä¸Šè»Šé‡'],
                alighting: ['ä¸‹è»Š', 'alighting', 'ä¸‹å®¢', 'ä¸‹è»Šé‡'],
                total: ['ç¸½é‡', 'total', 'åˆè¨ˆ', 'ç¸½è¨ˆ', 'ä¸Šä¸‹è»Š', 'è¼‰å®¢é‡'],
                longitude: ['ç¶“åº¦', 'longitude', 'lng', 'lon'],
                latitude: ['ç·¯åº¦', 'latitude', 'lat'],
                routes: ['è·¯ç·š', 'routes', 'è·¯ç·šæ•¸', 'route']
            };
            
            for (const [field, patterns_list] of Object.entries(patterns)) {
                mapping[field] = keys.find(key => 
                    patterns_list.some(pattern => 
                        key.toLowerCase().includes(pattern.toLowerCase()) ||
                        pattern.toLowerCase().includes(key.toLowerCase())
                    )
                ) || keys[0];
            }
            
            return mapping;
        }

        // æ¨¡æ“¬é€²åº¦æ¢
        function simulateProgress() {
            const progressFill = document.getElementById('progressFill');
            const fileStatus = document.getElementById('fileStatus');
            
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    fileStatus.textContent = 'æª”æ¡ˆè¼‰å…¥å®Œæˆ';
                } else {
                    fileStatus.textContent = `è¼‰å…¥ä¸­... ${Math.round(progress)}%`;
                }
                progressFill.style.width = progress + '%';
            }, 200);
        }

        // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        function showError(message) {
            const errorMsg = document.getElementById('errorMessage');
            errorMsg.textContent = message;
            errorMsg.style.display = 'block';
            document.getElementById('fileInfo').style.display = 'none';
        }

        // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
        function showSuccess(message) {
            const successMsg = document.getElementById('successMessage');
            successMsg.textContent = message;
            successMsg.style.display = 'block';
        }

        // è¨ˆç®—åœ°åœ–é‚Šç•Œ
        function calculateMapBounds() {
            const lngs = busStopsData.map(stop => stop.longitude);
            const lats = busStopsData.map(stop => stop.latitude);
            
            mapBounds = {
                minLng: Math.min(...lngs),
                maxLng: Math.max(...lngs),
                minLat: Math.min(...lats),
                maxLat: Math.max(...lats)
            };
            
            // æ·»åŠ é‚Šè·
            const lngPadding = (mapBounds.maxLng - mapBounds.minLng) * 0.1;
            const latPadding = (mapBounds.maxLat - mapBounds.minLat) * 0.1;
            
            mapBounds.minLng -= lngPadding;
            mapBounds.maxLng += lngPadding;
            mapBounds.minLat -= latPadding;
            mapBounds.maxLat += latPadding;
        }

        // ç¶“ç·¯åº¦è½‰æ›ç‚ºè¢å¹•åº§æ¨™
        function coordsToScreen(lng, lat) {
            const x = ((lng - mapBounds.minLng) / (mapBounds.maxLng - mapBounds.minLng)) * canvas.width;
            const y = canvas.height - ((lat - mapBounds.minLat) / (mapBounds.maxLat - mapBounds.minLat)) * canvas.height;
            
            return {
                x: (x + offsetX) * scale,
                y: (y + offsetY) * scale
            };
        }

        // å¡«å……ç¯©é¸é¸é …
        function populateFilters() {
            const districtSet = new Set();
            busStopsData.forEach(stop => districtSet.add(stop.district));
            
            const districtFilter = document.getElementById('districtFilter');
            districtFilter.innerHTML = '<option value="">å…¨éƒ¨è¡Œæ”¿å€</option>';
            
            Array.from(districtSet).sort().forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                districtFilter.appendChild(option);
            });
        }

        // è¨­ç½®äº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            document.getElementById('districtFilter').addEventListener('change', applyFilters);
            document.getElementById('passengerFilter').addEventListener('input', function(e) {
                document.getElementById('passengerValue').textContent = e.target.value;
                applyFilters();
            });
            document.getElementById('routeFilter').addEventListener('input', function(e) {
                document.getElementById('routeValue').textContent = e.target.value;
                applyFilters();
            });
            document.getElementById('showLabels').addEventListener('change', drawMap);
            document.getElementById('showHeatmap').addEventListener('change', drawMap);
        }

        // æ‡‰ç”¨ç¯©é¸å™¨
        function applyFilters() {
            if (busStopsData.length > 0) {
                drawMap();
                updateStats();
            }
        }

        // æ›´æ–°çµ±è¨ˆè³‡æ–™
        function updateStats() {
            const filteredData = getFilteredData();
            
            document.getElementById('totalStations').textContent = filteredData.length;
            
            if (filteredData.length > 0) {
                const avgPassengers = Math.round(
                    filteredData.reduce((sum, stop) => sum + stop.totalPassengers, 0) / filteredData.length
                );
                const maxPassengers = Math.max(...filteredData.map(stop => stop.totalPassengers));
                const totalRoutes = new Set(filteredData.map(stop => stop.routeCount)).size;
                
                document.getElementById('avgPassengers').textContent = avgPassengers.toLocaleString();
                document.getElementById('maxPassengers').textContent = maxPassengers.toLocaleString();
                document.getElementById('totalRoutes').textContent = totalRoutes;
            }
        }

        // ç²å–ç¯©é¸å¾Œçš„è³‡æ–™
        function getFilteredData() {
            const districtFilter = document.getElementById('districtFilter').value;
            const passengerFilter = parseInt(document.getElementById('passengerFilter').value);
            const routeFilter = parseInt(document.getElementById('routeFilter').value);
            
            return busStopsData.filter(stop => {
                const districtMatch = !districtFilter || stop.district === districtFilter;
                const passengerMatch = stop.totalPassengers >= passengerFilter;
                const routeMatch = stop.routeCount >= routeFilter;
                
                return districtMatch && passengerMatch && routeMatch;
            });
        }

        // ç¹ªè£½åœ°åœ–
        function drawMap() {
            const filteredData = getFilteredData();
            
            // å¦‚æœæœ‰ Leafletï¼Œä½¿ç”¨ Leaflet æ¨¡å¼
            if (map && typeof L !== 'undefined') {
                drawLeafletMarkers(filteredData);
            } else {
                // å¦å‰‡ä½¿ç”¨ Canvas æ¨¡å¼
                drawCanvasMap(filteredData);
            }
        }

        // Leaflet æ¨™è¨˜ç¹ªè£½
        function drawLeafletMarkers(filteredData) {
            // æ¸…é™¤ç¾æœ‰æ¨™è¨˜
            if (markerGroup) {
                markerGroup.clearLayers();
            }

            // å‰µå»ºæ–°æ¨™è¨˜
            filteredData.forEach(stop => {
                // æ ¹æ“šè¼‰å®¢é‡æ±ºå®šé¡è‰²å’Œå¤§å°
                let color, radius;
                if (stop.totalPassengers > 3000) {
                    color = '#ff4444';
                    radius = 12;
                } else if (stop.totalPassengers > 1000) {
                    color = '#ffaa00';
                    radius = 8;
                } else {
                    color = '#00aa44';
                    radius = 6;
                }

                // å‰µå»ºåœ“å½¢æ¨™è¨˜
                const marker = L.circleMarker([stop.latitude, stop.longitude], {
                    radius: radius,
                    fillColor: color,
                    color: '#ffffff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                });

                // å‰µå»ºå½ˆå‡ºè¦–çª—å…§å®¹
                const popupContent = `
                    <div style="font-family: Microsoft JhengHei; min-width: 200px;">
                        <h3 style="margin: 0 0 10px 0; color: #2d3748;">${stop.name}</h3>
                        <p style="margin: 5px 0;"><strong>è¡Œæ”¿å€ï¼š</strong>${stop.district}</p>
                        <p style="margin: 5px 0;"><strong>æ—¥è¼‰å®¢é‡ï¼š</strong>${stop.totalPassengers.toLocaleString()} äººæ¬¡</p>
                        <p style="margin: 5px 0;"><strong>è·¯ç·šæ•¸ï¼š</strong>${stop.routeCount} æ¢</p>
                        <p style="margin: 5px 0;"><strong>ä¸Šè»Šï¼š</strong>${stop.boardingAvg.toLocaleString()} äººæ¬¡</p>
                        <p style="margin: 5px 0;"><strong>ä¸‹è»Šï¼š</strong>${stop.alightingAvg.toLocaleString()} äººæ¬¡</p>
                    </div>
                `;

                // ç¶å®šå½ˆå‡ºè¦–çª—
                marker.bindPopup(popupContent);

                // æ·»åŠ åˆ°æ¨™è¨˜ç¾¤çµ„
                markerGroup.addLayer(marker);
            });
        }

        // Canvas åœ°åœ–ç¹ªè£½ï¼ˆå‚™ç”¨æ¨¡å¼ï¼‰
        function drawCanvasMap(filteredData) {
            if (!canvas || !ctx) return;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç¹ªè£½ç¶²æ ¼
            if (showGrid) {
                drawGrid();
            }
            
            const showLabels = document.getElementById('showLabels').checked;
            const showHeatmap = document.getElementById('showHeatmap').checked;
            
            if (showHeatmap) {
                drawHeatmap(filteredData);
            }
            
            // ç¹ªè£½ç«™é»
            filteredData.forEach(stop => {
                const coords = coordsToScreen(stop.longitude, stop.latitude);
                
                // æ ¹æ“šè¼‰å®¢é‡æ±ºå®šé¡è‰²å’Œå¤§å°
                let color, size;
                if (stop.totalPassengers > 3000) {
                    color = '#ff4444';
                    size = 8;
                } else if (stop.totalPassengers > 1000) {
                    color = '#ffaa00';
                    size = 6;
                } else {
                    color = '#00aa44';
                    size = 4;
                }
                
                // ç¹ªè£½åœ“é»
                ctx.beginPath();
                ctx.arc(coords.x, coords.y, size, 0, 2 * Math.PI);
                ctx.fillStyle = color;
                ctx.fill();
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // ç¹ªè£½ç«™å
                if (showLabels && scale > 1.5) {
                    ctx.fillStyle = '#2d3748';
                    ctx.font = '12px Microsoft JhengHei';
                    ctx.textAlign = 'center';
                    ctx.fillText(stop.name, coords.x, coords.y + size + 15);
                }
            });
        }

        // ç¹ªè£½ç¶²æ ¼
        function drawGrid() {
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 1;
            
            const gridSize = 50;
            
            for (let x = 0; x < canvas.width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            for (let y = 0; y < canvas.height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
        }

        // ç¹ªè£½ç†±åŠ›åœ–
        function drawHeatmap(data) {
            data.forEach(stop => {
                const coords = coordsToScreen(stop.longitude, stop.latitude);
                const intensity = Math.min(stop.totalPassengers / 5000, 1);
                const radius = 30 * intensity;
                
                const gradient = ctx.createRadialGradient(coords.x, coords.y, 0, coords.x, coords.y, radius);
                gradient.addColorStop(0, `rgba(255, 0, 0, ${intensity * 0.3})`);
                gradient.addColorStop(1, 'rgba(255, 0, 0, 0)');
                
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(coords.x, coords.y, radius, 0, 2 * Math.PI);
                ctx.fill();
            });
        }

        // æ»‘é¼ äº‹ä»¶è™•ç†
        function onMouseDown(e) {
            isDragging = true;
            const rect = canvas.getBoundingClientRect();
            lastMousePos = {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
            canvas.style.cursor = 'grabbing';
        }

        function onMouseUp() {
            isDragging = false;
            canvas.style.cursor = 'default';
        }

        function onMouseMove(e) {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            if (isDragging) {
                const deltaX = mouseX - lastMousePos.x;
                const deltaY = mouseY - lastMousePos.y;
                
                offsetX += deltaX / scale;
                offsetY += deltaY / scale;
                
                lastMousePos = { x: mouseX, y: mouseY };
                drawMap();
                return;
            }
            
            // æª¢æŸ¥æ»‘é¼ æ‡¸åœ
            const filteredData = getFilteredData();
            let foundStop = null;
            
            filteredData.forEach(stop => {
                const coords = coordsToScreen(stop.longitude, stop.latitude);
                const distance = Math.sqrt(
                    Math.pow(mouseX - coords.x, 2) + Math.pow(mouseY - coords.y, 2)
                );
                
                if (distance <= 10) {
                    foundStop = stop;
                }
            });
            
            if (foundStop !== hoveredStop) {
                hoveredStop = foundStop;
                showTooltip(e, foundStop);
                canvas.style.cursor = foundStop ? 'pointer' : 'default';
            }
        }

        function onMouseOut() {
            hoveredStop = null;
            hideTooltip();
            canvas.style.cursor = 'default';
        }

        function onWheel(e) {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            scale *= delta;
            scale = Math.max(0.5, Math.min(scale, 5));
            drawMap();
        }

        // æç¤ºæ¡†
        function showTooltip(e, stop) {
            const tooltip = document.getElementById('tooltip');
            if (stop) {
                tooltip.innerHTML = `
                    <strong>${stop.name}</strong><br>
                    è¡Œæ”¿å€ï¼š${stop.district}<br>
                    æ—¥è¼‰å®¢é‡ï¼š${stop.totalPassengers.toLocaleString()}äººæ¬¡<br>
                    è·¯ç·šæ•¸ï¼š${stop.routeCount}æ¢<br>
                    ä¸Šè»Šï¼š${stop.boardingAvg.toLocaleString()}äººæ¬¡<br>
                    ä¸‹è»Šï¼š${stop.alightingAvg.toLocaleString()}äººæ¬¡
                `;
                tooltip.style.display = 'block';
                tooltip.style.left = e.pageX + 10 + 'px';
                tooltip.style.top = e.pageY - 10 + 'px';
            } else {
                hideTooltip();
            }
        }

        function hideTooltip() {
            document.getElementById('tooltip').style.display = 'none';
        }

        // åœ°åœ–æ§åˆ¶åŠŸèƒ½
        function zoomIn() {
            if (map && typeof L !== 'undefined') {
                map.setZoom(map.getZoom() + 1);
            } else {
                scale *= 1.2;
                scale = Math.min(scale, 5);
                drawMap();
            }
        }

        function zoomOut() {
            if (map && typeof L !== 'undefined') {
                map.setZoom(map.getZoom() - 1);
            } else {
                scale *= 0.8;
                scale = Math.max(scale, 0.5);
                drawMap();
            }
        }

        function resetView() {
            if (map && typeof L !== 'undefined') {
                map.setView([24.9937, 121.3010], 11);
            } else {
                scale = 1;
                offsetX = 0;
                offsetY = 0;
                drawMap();
            }
        }

        function fitMapToMarkers() {
            if (busStopsData.length === 0) return;
            
            if (map && typeof L !== 'undefined') {
                const filteredData = getFilteredData();
                
                if (filteredData.length > 0) {
                    const group = new L.featureGroup();
                    filteredData.forEach(stop => {
                        group.addLayer(L.marker([stop.latitude, stop.longitude]));
                    });
                    map.fitBounds(group.getBounds().pad(0.1));
                }
            } else {
                calculateMapBounds();
                resetView();
            }
        }

        function toggleGrid() {
            showGrid = !showGrid;
            drawMap();
        }

        function exportData() {
            if (busStopsData.length === 0) {
                showError('æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º');
                return;
            }
            
            const filteredData = getFilteredData();
            const excelData = [
                ['æ’å', 'ç«™ä½åç¨±', 'è¡Œæ”¿å€', 'ä¸Šè»Šé‡', 'ä¸‹è»Šé‡', 'ç¸½è¼‰å®¢é‡', 'ç¶“åº¦', 'ç·¯åº¦', 'è·¯ç·šæ•¸'],
                ...filteredData.map(stop => [
                    stop.rank,
                    stop.name,
                    stop.district,
                    stop.boardingAvg,
                    stop.alightingAvg,
                    stop.totalPassengers,
                    stop.longitude,
                    stop.latitude,
                    stop.routeCount
                ])
            ];
            
            // å‰µå»º Excel å·¥ä½œç°¿
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'å…¬è»Šç«™ä½è³‡æ–™');
            
            // ä¸‹è¼‰ Excel æª”æ¡ˆ
            XLSX.writeFile(wb, 'ç¯©é¸å¾Œçš„å…¬è»Šç«™ä½è³‡æ–™.xlsx');
            
            showSuccess('è³‡æ–™åŒ¯å‡ºæˆåŠŸï¼');
        }
    </script>
</body>
</html>
